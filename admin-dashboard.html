<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Apartment Types, CCTV & Payments</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="dashboard-wrapper">
        <div class="sidebar">
            <div class="logo">
                <h1>MyShop</h1>
            </div>
            <ul class="menu">
                <li><a href="#apartment-types" class="active"><i class="fas fa-building"></i> Apartment Types</a></li>
                <li><a href="#cctv-surveillance"><i class="fas fa-video"></i> CCTV Surveillance</a></li>
                <li><a href="#revenue-management"><i class="fas fa-chart-line"></i> Revenue Management</a></li>
                <li><a href="#emi-management"><i class="fas fa-money-bill-wave"></i> EMI Management</a></li>
                <li><a href="#customer-management"><i class="fas fa-users"></i> Customer Management</a></li>
                <li><a href="index.html"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
            </ul>
        </div>

        <div class="main-content">
            <div class="header">
                <h1>Admin Dashboard</h1>
                <a href="index.html" class="logout-btn">Logout</a>
            </div>

            <div class="section" id="apartment-types">
                <h2>Apartment Types</h2>
                <div class="apartment-grid">
                    <!-- 1BHK Apartments -->
                    <div class="apartment-card">
                        <img src="https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?w=400&h=300&fit=crop" alt="1BHK Apartment" class="apartment-image">
                        <h3>1BHK Apartments</h3>
                        <div class="apartment-details">
                            <p>Total Units: 20</p>
                            <p>Available: <span id="1bhk-available">20/20</span></p>
                            <p>Area: 500-600 sq.ft</p>
                            <p>Monthly Rent: ₹15,000 - ₹20,000</p>
                        </div>
                        <span class="status available">Available</span>
                    </div>

                    <!-- 2BHK Apartments -->
                    <div class="apartment-card">
                        <img src="https://images.unsplash.com/photo-1560185007-5f0bb1866cab?w=400&h=300&fit=crop" alt="2BHK Apartment" class="apartment-image">
                        <h3>2BHK Apartments</h3>
                        <div class="apartment-details">
                            <p>Total Units: 15</p>
                            <p>Available: <span id="2bhk-available">15/15</span></p>
                            <p>Area: 800-1000 sq.ft</p>
                            <p>Monthly Rent: ₹25,000 - ₹35,000</p>
                        </div>
                        <span class="status available">Available</span>
                    </div>

                    <!-- 3BHK Apartments -->
                    <div class="apartment-card">
                        <img src="https://images.unsplash.com/photo-1600607687939-ce8a6c25118c?w=400&h=300&fit=crop" alt="3BHK Apartment" class="apartment-image">
                        <h3>3BHK Apartments</h3>
                        <div class="apartment-details">
                            <p>Total Units: 10</p>
                            <p>Available: <span id="3bhk-available">10/10</span></p>
                            <p>Area: 1200-1500 sq.ft</p>
                            <p>Monthly Rent: ₹40,000 - ₹55,000</p>
                        </div>
                        <span class="status available">Available</span>
                    </div>

                    <!-- Single Bedroom -->
                    <div class="apartment-card">
                        <img src="https://images.unsplash.com/photo-1522708323590-d24dbb6b0267?w=400&h=300&fit=crop" alt="Single Bedroom" class="apartment-image">
                        <h3>Single Bedroom</h3>
                        <div class="apartment-details">
                            <p>Total Units: 25</p>
                            <p>Available: <span id="single-bedroom-available">25/25</span></p>
                            <p>Area: 400-500 sq.ft</p>
                            <p>Monthly Rent: ₹12,000 - ₹15,000</p>
                        </div>
                        <span class="status available">Available</span>
                    </div>

                    <!-- Studio Apartments -->
                    <div class="apartment-card">
                        <img src="https://images.unsplash.com/photo-1502672260266-1c1ef2d93688?w=400&h=300&fit=crop" alt="Studio Apartment" class="apartment-image">
                        <h3>Studio Apartments</h3>
                        <div class="apartment-details">
                            <p>Total Units: 30</p>
                            <p>Available: <span id="studio-available">30/30</span></p>
                            <p>Area: 300-400 sq.ft</p>
                            <p>Monthly Rent: ₹10,000 - ₹12,000</p>
                        </div>
                        <span class="status available">Available</span>
                    </div>

                    <!-- Penthouse -->
                    <div class="apartment-card">
                        <img src="https://images.unsplash.com/photo-1600585154340-be6161a56a0c?w=400&h=300&fit=crop" alt="Penthouse" class="apartment-image">
                        <h3>Penthouse</h3>
                        <div class="apartment-details">
                            <p>Total Units: 5</p>
                            <p>Available: <span id="penthouse-available">5/5</span></p>
                            <p>Area: 2000-2500 sq.ft</p>
                            <p>Monthly Rent: ₹80,000 - ₹1,00,000</p>
                        </div>
                        <span class="status available">Available</span>
                    </div>
                </div>
            </div>

            <div class="section" id="cctv-surveillance">
                <h2>CCTV Surveillance</h2>
                <div class="cctv-grid">
                    <!-- Main Entrance -->
                    <div class="cctv-card">
                        <img src="https://st.hzcdn.com/simgs/5372402307e72ff0_9-8901/_.jpg" alt="Main Entrance CCTV" class="cctv-image">
                        <h3>Main Entrance</h3>
                        <div class="cctv-controls">
                            <button class="cctv-btn" onclick="controlCCTV('main-entrance', 'view')">View</button>
                            <button class="cctv-btn record" onclick="controlCCTV('main-entrance', 'record')">Record</button>
                        </div>
                        <p class="cctv-status">Status: Active</p>
                    </div>

                    <!-- Parking Area -->
                    <div class="cctv-card">
                        <img src="https://images.unsplash.com/photo-1573348722427-f1d6819fdf98?w=400&h=300&fit=crop" alt="Parking Area CCTV" class="cctv-image">
                        <h3>Parking Area</h3>
                        <div class="cctv-controls">
                            <button class="cctv-btn" onclick="controlCCTV('parking', 'view')">View</button>
                            <button class="cctv-btn record" onclick="controlCCTV('parking', 'record')">Record</button>
                        </div>
                        <p class="cctv-status">Status: Active</p>
                    </div>

                    <!-- Swimming Pool -->
                    <div class="cctv-card">
                        <img src="https://images.unsplash.com/photo-1576013551627-0cc20b96c2a7?w=400&h=300&fit=crop" alt="Swimming Pool CCTV" class="cctv-image">
                        <h3>Swimming Pool</h3>
                        <div class="cctv-controls">
                            <button class="cctv-btn" onclick="controlCCTV('pool', 'view')">View</button>
                            <button class="cctv-btn record" onclick="controlCCTV('pool', 'record')">Record</button>
                        </div>
                        <p class="cctv-status">Status: Active</p>
                    </div>

                    <!-- Gym Area -->
                    <div class="cctv-card">
                        <img src="https://images.unsplash.com/photo-1534438327276-14e5300c3a48?w=400&h=300&fit=crop" alt="Gym Area CCTV" class="cctv-image">
                        <h3>Gym Area</h3>
                        <div class="cctv-controls">
                            <button class="cctv-btn" onclick="controlCCTV('gym', 'view')">View</button>
                            <button class="cctv-btn record" onclick="controlCCTV('gym', 'record')">Record</button>
                        </div>
                        <p class="cctv-status">Status: Active</p>
                    </div>

                    <!-- Garden Area -->
                    <div class="cctv-card">
                        <img src="https://images.unsplash.com/photo-1585320806297-9794b3e4eeae?w=400&h=300&fit=crop" alt="Garden Area CCTV" class="cctv-image">
                        <h3>Garden Area</h3>
                        <div class="cctv-controls">
                            <button class="cctv-btn" onclick="controlCCTV('garden', 'view')">View</button>
                            <button class="cctv-btn record" onclick="controlCCTV('garden', 'record')">Record</button>
                        </div>
                        <p class="cctv-status">Status: Active</p>
                    </div>

                    <!-- Security Room -->
                    <div class="cctv-card">
                        <img src="https://digitalsecurityguard.com/wp-content/uploads/2020/02/remote_guard_security.jpg" alt="Security Room CCTV" class="cctv-image">
                        <h3>Security Room</h3>
                        <div class="cctv-controls">
                            <button class="cctv-btn" onclick="controlCCTV('security', 'view')">View</button>
                            <button class="cctv-btn record" onclick="controlCCTV('security', 'record')">Record</button>
                        </div>
                        <p class="cctv-status">Status: Active</p>
                    </div>
                </div>
            </div>

            <div class="section" id="revenue-management">
                <h2>Revenue Management</h2>
                <button class="toggle-payment-btn" onclick="window.location.href='revenue.html'">
                    <i class="fas fa-chart-line"></i>
                    View Revenue Reports
                </button>
            </div>

            <div class="section" id="emi-management">
                <h2>EMI Management</h2>
                <button class="toggle-payment-btn" onclick="window.location.href='emi-management.html'" style="margin-left: 10px;">
                    <i class="fas fa-money-bill-wave"></i>
                    View EMI Details
                </button>
            </div>

            <div class="section customer-section" id="customer-management">
                <h2>Customer Management</h2>
                <div class="filter-controls">
                    <input type="text" id="customerSearch" class="search-input" placeholder="Search customers...">
                    <select id="customerFilter" class="filter-select">
                        <option value="all">All Customers</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
                <table class="customer-table">
                    <thead>
                        <tr>
                            <th>Full Name</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Apartment Type</th>
                            <th>Member Since</th>
                            <th>Outstanding Bills</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="customerTableBody">
                        <!-- Customer data will be populated here -->
                    </tbody>
                </table>
                <div class="add-customer-bill-section" style="margin-top: 20px;">
                    <button class="cctv-btn" onclick="showNewCustomerBillForm()">Add New Customer Bill</button>
                </div>
            </div>
        </div>

        <!-- Customer Details Modal -->
        <div id="customerModal" class="modal">
            <div class="modal-content">
                <span class="close-modal" onclick="closeCustomerModal()">&times;</span>
                <h2>Customer Details</h2>
                <div class="customer-details-grid">
                    <div class="detail-card">
                        <h3>Personal Information</h3>
                        <div class="detail-item">
                            <strong>Full Name</strong>
                            <span id="modalFullName"></span>
                        </div>
                        <div class="detail-item">
                            <strong>Email</strong>
                            <span id="modalEmail"></span>
                        </div>
                        <div class="detail-item">
                            <strong>Phone</strong>
                            <span id="modalPhone"></span>
                        </div>
                        <div class="detail-item">
                            <strong>Address</strong>
                            <span id="modalAddress"></span>
                        </div>
                    </div>
                    <div class="detail-card">
                        <h3>Apartment Information</h3>
                        <div class="detail-item">
                            <strong>Apartment Type</strong>
                            <span id="modalApartmentType"></span>
                        </div>
                        <div class="detail-item">
                            <strong>Area</strong>
                            <span id="modalArea"></span>
                        </div>
                        <div class="detail-item">
                            <strong>Monthly Rent</strong>
                            <span id="modalRent"></span>
                        </div>
                        <div class="detail-item">
                            <strong>Move-in Date</strong>
                            <span id="modalMoveIn"></span>
                        </div>
                    </div>
                    <div class="detail-card">
                        <h3>Account Information</h3>
                        <div class="detail-item">
                            <strong>Username</strong>
                            <span id="modalUsername"></span>
                        </div>
                        <div class="detail-item">
                            <strong>Member Since</strong>
                            <span id="modalMemberSince"></span>
                        </div>
                        <div class="detail-item">
                            <strong>Status</strong>
                            <span id="modalStatus" class="customer-status active">Active</span>
                        </div>
                    </div>
                    <div class="detail-card full-width">
                        <h3>Customer History</h3>
                        <div id="customerHistory" class="history-list">
                            <!-- History items will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- New Customer Bill Modal -->
        <div id="newCustomerBillModal" class="modal">
            <div class="modal-content">
                <span class="close-modal" onclick="closeNewCustomerBillModal()">&times;</span>
                <h2>New Customer Bill</h2>
                <form id="newCustomerBillForm">
                    <div class="form-group">
                        <label for="billCustomerName">Customer Name:</label>
                        <input type="text" id="billCustomerName" required>
                    </div>
                    <div class="form-group">
                        <label for="billAmount">Amount:</label>
                        <input type="number" id="billAmount" required>
                    </div>
                    <div class="form-group">
                        <label for="billDueDate">Due Date:</label>
                        <input type="date" id="billDueDate" required>
                    </div>
                    <div class="form-group">
                        <label for="billDescription">Description:</label>
                        <textarea id="billDescription"></textarea>
                    </div>
                    <button type="submit" class="cctv-btn">Add Bill</button>
                </form>
            </div>
        </div>

        <!-- Apartment Details Modal -->
        <div id="apartmentModal" class="modal">
            <div class="modal-content">
                <span class="close-modal" onclick="closeApartmentModal()">&times;</span>
                <h2 id="modalApartmentTitle">Apartment Details</h2>
                <div class="apartment-details-grid">
                    <div class="detail-card">
                        <h3>Apartment Information</h3>
                        <div class="detail-item">
                            <strong>Total Units</strong>
                            <span id="modalTotalUnits"></span>
                        </div>
                        <div class="detail-item">
                            <strong>Available Units</strong>
                            <span id="modalAvailableUnits"></span>
                        </div>
                        <div class="detail-item">
                            <strong>Area</strong>
                            <span id="modalApartmentArea"></span>
                        </div>
                        <div class="detail-item">
                            <strong>Monthly Rent</strong>
                            <span id="modalApartmentRent"></span>
                        </div>
                    </div>
                    <div class="detail-card">
                        <h3>Current Customers</h3>
                        <div id="modalCustomerList" class="customer-list">
                            <!-- Customer list will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize apartment data in localStorage if not exists
        function initializeApartmentData() {
            const apartmentData = {
                '1BHK': { total: 20, available: 20 },
                '2BHK': { total: 15, available: 15 },
                '3BHK': { total: 10, available: 10 },
                'Single Bedroom': { total: 25, available: 25 },
                'Studio': { total: 30, available: 30 },
                'Penthouse': { total: 5, available: 5 }
            };

            // Force update apartment data
            localStorage.setItem('apartmentData', JSON.stringify(apartmentData));
        }

        // Initialize customer data
        function initializeCustomerData() {
            // Don't clear existing customer data
            if (!localStorage.getItem('customers')) {
                localStorage.setItem('customers', JSON.stringify([]));
            }
        }

        // Function to load customer data
        function loadCustomerData() {
            const customers = JSON.parse(localStorage.getItem('customers')) || [];
            const customerTableBody = document.getElementById('customerTableBody');
            customerTableBody.innerHTML = '';

            if (customers.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="6" style="text-align: center;">No customers found</td>';
                customerTableBody.appendChild(row);
                return;
            }

            // Sort customers by registration date (newest first)
            customers.sort((a, b) => new Date(b.registrationDate) - new Date(a.registrationDate));

            customers.forEach(customer => {
                const row = document.createElement('tr');
                // Add highlight class for new registrations
                const isNew = new Date(customer.registrationDate) > new Date(Date.now() - 5 * 60 * 1000); // Within last 5 minutes
                row.className = isNew ? 'new-registration' : '';
                
                // Calculate outstanding bills
                const pendingBillsCount = (customer.bills || []).filter(bill => bill.status === 'pending').length;
                const outstandingBillsHtml = pendingBillsCount > 0 ? `<span class="status pending">${pendingBillsCount} Pending</span>` : `<span class="status paid">All Paid</span>`;

                row.innerHTML = `
                    <td>${customer.fullname || 'N/A'}</td>
                    <td>${customer.email || 'N/A'}</td>
                    <td>${customer.phone || 'N/A'}</td>
                    <td>${customer.apartmentType || 'N/A'}</td>
                    <td>${formatDate(customer.registrationDate) || 'N/A'}</td>
                    <td>${outstandingBillsHtml}</td>
                    <td>
                        <button onclick="editCustomer('${customer.username}')" class="edit-btn">Edit</button>
                        <button onclick="deleteCustomer('${customer.username}')" class="delete-btn">Delete</button>
                    </td>
                `;

                // Add click handler for the entire row
                row.addEventListener('click', function(e) {
                    // Don't trigger if clicking on buttons
                    if (!e.target.classList.contains('edit-btn') && !e.target.classList.contains('delete-btn')) {
                        showCustomerDetails(customer);
                    }
                });

                customerTableBody.appendChild(row);
            });

            // Update apartment availability after loading customer data
            updateApartmentAvailability();
        }

        // Add auto-refresh functionality
        function startAutoRefresh() {
            // Refresh customer data every 5 seconds
            setInterval(loadCustomerData, 5000);
        }

        // Initialize data when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeApartmentData();
            initializeCustomerData();
            updateApartmentAvailability(); // Update availability based on current customers
            loadCustomerData();
            startAutoRefresh();
        });

        function controlCCTV(camera, action) {
            if (action === 'view') {
                alert(`Opening live feed for ${camera.replace('-', ' ')}`);
            } else if (action === 'record') {
                alert(`Starting recording for ${camera.replace('-', ' ')}`);
            }
        }

        function showEMIOptions(apartmentType) {
            const apartmentData = JSON.parse(localStorage.getItem('apartmentData'));
            if (apartmentData[apartmentType].available === 0) {
                alert('Sorry, this apartment type is currently not available.');
                return;
            }

            const emiDetails = {
                '1BHK': {
                    price: '₹75,00,000',
                    downPayment: '₹15,00,000',
                    emiOptions: [
                        { years: 5, monthlyEMI: '₹1,25,000' },
                        { years: 10, monthlyEMI: '₹75,000' },
                        { years: 15, monthlyEMI: '₹55,000' },
                        { years: 20, monthlyEMI: '₹45,000' }
                    ]
                },
                '2BHK': {
                    price: '₹1,50,00,000',
                    downPayment: '₹30,00,000',
                    emiOptions: [
                        { years: 5, monthlyEMI: '₹2,50,000' },
                        { years: 10, monthlyEMI: '₹1,50,000' },
                        { years: 15, monthlyEMI: '₹1,10,000' },
                        { years: 20, monthlyEMI: '₹90,000' }
                    ]
                },
                '3BHK': {
                    price: '₹2,25,00,000',
                    downPayment: '₹45,00,000',
                    emiOptions: [
                        { years: 5, monthlyEMI: '₹3,75,000' },
                        { years: 10, monthlyEMI: '₹2,25,000' },
                        { years: 15, monthlyEMI: '₹1,65,000' },
                        { years: 20, monthlyEMI: '₹1,35,000' }
                    ]
                },
                'Single Bedroom': {
                    price: '₹60,00,000',
                    downPayment: '₹12,00,000',
                    emiOptions: [
                        { years: 5, monthlyEMI: '₹1,00,000' },
                        { years: 10, monthlyEMI: '₹60,000' },
                        { years: 15, monthlyEMI: '₹44,000' },
                        { years: 20, monthlyEMI: '₹36,000' }
                    ]
                },
                'Studio': {
                    price: '₹45,00,000',
                    downPayment: '₹9,00,000',
                    emiOptions: [
                        { years: 5, monthlyEMI: '₹75,000' },
                        { years: 10, monthlyEMI: '₹45,000' },
                        { years: 15, monthlyEMI: '₹33,000' },
                        { years: 20, monthlyEMI: '₹27,000' }
                    ]
                },
                'Penthouse': {
                    price: '₹3,75,00,000',
                    downPayment: '₹75,00,000',
                    emiOptions: [
                        { years: 5, monthlyEMI: '₹6,25,000' },
                        { years: 10, monthlyEMI: '₹3,75,000' },
                        { years: 15, monthlyEMI: '₹2,75,000' },
                        { years: 20, monthlyEMI: '₹2,25,000' }
                    ]
                }
            };

            const details = emiDetails[apartmentType];
            let message = `${apartmentType} EMI Options:\n\n`;
            message += `Total Price: ${details.price}\n`;
            message += `Down Payment (20%): ${details.downPayment}\n\n`;
            message += 'EMI Options:\n';
            details.emiOptions.forEach(option => {
                message += `${option.years} years: ₹${option.monthlyEMI} per month\n`;
            });
            message += '\nNote: Interest rate of 8.5% p.a. is applicable.';

            alert(message);
        }

        function filterHistory() {
            const filter = document.querySelector('.filter-select').value;
            const rows = document.querySelectorAll('.history-table tbody tr');
            
            rows.forEach(row => {
                const billType = row.cells[2].textContent.toLowerCase();
                if (filter === 'all' || billType.includes(filter.toLowerCase())) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function filterByDate() {
            const date = document.querySelector('.date-input').value;
            const rows = document.querySelectorAll('.history-table tbody tr');
            
            rows.forEach(row => {
                const rowDate = new Date(row.cells[0].textContent);
                const filterDate = new Date(date);
                
                if (date === '' || rowDate.toDateString() === filterDate.toDateString()) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function searchHistory() {
            const searchText = document.querySelector('.search-input').value.toLowerCase();
            const rows = document.querySelectorAll('.history-table tbody tr');
            
            rows.forEach(row => {
                const customerName = row.cells[1].textContent.toLowerCase();
                if (customerName.includes(searchText)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function exportToExcel() {
            // This is a placeholder for Excel export functionality
            alert('Export to Excel functionality will be implemented here');
        }

        // Function to format date
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            try {
                const options = { year: 'numeric', month: 'long', day: 'numeric' };
                return new Date(dateString).toLocaleDateString(undefined, options);
            } catch (error) {
                console.error('Error formatting date:', error);
                return 'Invalid Date';
            }
        }

        // Function to edit customer
        function editCustomer(username) {
            const customers = JSON.parse(localStorage.getItem('customers')) || [];
            const customer = customers.find(c => c.username === username);
            
            if (customer) {
                const newApartmentType = prompt('Enter new apartment type:', customer.apartmentType);
                if (newApartmentType && newApartmentType !== customer.apartmentType) {
                    // Update apartment availability
                    const apartmentData = JSON.parse(localStorage.getItem('apartmentData')) || {};
                    
                    // Increase availability for old apartment type
                    if (apartmentData[customer.apartmentType]) {
                        apartmentData[customer.apartmentType].available++;
                    }
                    
                    // Decrease availability for new apartment type
                    if (apartmentData[newApartmentType]) {
                        if (apartmentData[newApartmentType].available <= 0) {
                            alert('No units available for the selected apartment type.');
                            return;
                        }
                        apartmentData[newApartmentType].available--;
                    }
                    
                    // Track apartment change in customer history
                    if (!customer.apartmentChanges) {
                        customer.apartmentChanges = [];
                    }
                    customer.apartmentChanges.push({
                        from: customer.apartmentType,
                        to: newApartmentType,
                        date: new Date().toISOString()
                    });
                    
                    // Update customer's apartment type
                    customer.apartmentType = newApartmentType;
                    
                    // Save changes
                    localStorage.setItem('customers', JSON.stringify(customers));
                    localStorage.setItem('apartmentData', JSON.stringify(apartmentData));
                    
                    // Reload customer data
                    loadCustomerData();
                    alert('Customer information updated successfully!');
                }
            }
        }

        // Function to delete customer
        function deleteCustomer(username) {
            if (confirm('Are you sure you want to delete this customer?')) {
                const customers = JSON.parse(localStorage.getItem('customers')) || [];
                const customer = customers.find(c => c.username === username);
                
                if (customer) {
                    // Update apartment availability
                    const apartmentData = JSON.parse(localStorage.getItem('apartmentData')) || {};
                    if (apartmentData[customer.apartmentType]) {
                        apartmentData[customer.apartmentType].available++;
                        localStorage.setItem('apartmentData', JSON.stringify(apartmentData));
                    }
                }

                // Remove customer
                const updatedCustomers = customers.filter(c => c.username !== username);
                localStorage.setItem('customers', JSON.stringify(updatedCustomers));
                
                // Reload customer data
                loadCustomerData();
                alert('Customer deleted successfully!');
            }
        }

        // Search functionality
        document.getElementById('customerSearch').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('#customerTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        });

        // Filter functionality
        document.getElementById('customerFilter').addEventListener('change', function(e) {
            const filter = e.target.value;
            const rows = document.querySelectorAll('#customerTableBody tr');
            
            rows.forEach(row => {
                if (filter === 'all') {
                    row.style.display = '';
                } else {
                    const apartmentType = row.cells[3].textContent.toLowerCase();
                    row.style.display = apartmentType === filter.toLowerCase() ? '' : 'none';
                }
            });
        });

        // Function to show customer details in modal
        function showCustomerDetails(customer) {
            const modal = document.getElementById('customerModal');
            const apartmentDetails = getApartmentDetails(customer.apartmentType);

            // Update modal content with customer details
            document.getElementById('modalFullName').textContent = customer.fullname || 'N/A';
            document.getElementById('modalEmail').textContent = customer.email || 'N/A';
            document.getElementById('modalPhone').textContent = customer.phone || 'N/A';
            document.getElementById('modalAddress').textContent = customer.address || 'N/A';
            document.getElementById('modalApartmentType').textContent = customer.apartmentType || 'N/A';
            document.getElementById('modalArea').textContent = apartmentDetails.area;
            document.getElementById('modalRent').textContent = apartmentDetails.rent;
            document.getElementById('modalUsername').textContent = customer.username || 'N/A';
            document.getElementById('modalMemberSince').textContent = formatDate(customer.registrationDate) || 'N/A';
            document.getElementById('modalMoveIn').textContent = formatDate(customer.registrationDate) || 'N/A';

            // Generate and display customer history
            displayCustomerHistory(customer);

            // Show the modal
            modal.style.display = 'flex';
        }

        function displayCustomerHistory(customer) {
            const historyContainer = document.getElementById('customerHistory');
            const history = generateCustomerHistory(customer);
            
            if (history.length === 0) {
                historyContainer.innerHTML = '<p>No history available for this customer.</p>';
                return;
            }

            historyContainer.innerHTML = history.map(item => `
                <div class="history-item">
                    <h4>
                        <span class="action-type ${item.type}">${item.type}</span>
                        ${item.title}
                    </h4>
                    <p>${item.description}</p>
                    <p class="timestamp">${formatDate(item.timestamp)}</p>
                </div>
            `).join('');
        }

        function generateCustomerHistory(customer) {
            const history = [];
            
            // Add registration event
            history.push({
                type: 'registration',
                title: 'Community Registration',
                description: `Joined the community and moved into ${customer.apartmentType}`,
                timestamp: customer.registrationDate
            });

            // Add apartment changes if any
            if (customer.apartmentChanges) {
                customer.apartmentChanges.forEach(change => {
                    history.push({
                        type: 'apartment-change',
                        title: 'Apartment Change',
                        description: `Changed apartment from ${change.from} to ${change.to}`,
                        timestamp: change.date
                    });
                });
            }

            // Add maintenance requests if any
            if (customer.maintenanceRequests) {
                customer.maintenanceRequests.forEach(request => {
                    history.push({
                        type: 'maintenance',
                        title: 'Maintenance Request',
                        description: request.description,
                        timestamp: request.date
                    });
                });
            }

            // Add complaints if any
            if (customer.complaints) {
                customer.complaints.forEach(complaint => {
                    history.push({
                        type: 'complaint',
                        title: 'Complaint Filed',
                        description: complaint.description,
                        timestamp: complaint.date
                    });
                });
            }

            // Add payments if any
            if (customer.payments) {
                customer.payments.forEach(payment => {
                    history.push({
                        type: 'payment',
                        title: 'Payment Made',
                        description: `Paid ₹${payment.amount} for ${payment.purpose}`,
                        timestamp: payment.date
                    });
                });
            }

            // Sort history by timestamp (newest first)
            return history.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        }

        // Function to close customer modal
        function closeCustomerModal() {
            const modal = document.getElementById('customerModal');
            modal.style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('customerModal');
            const apartmentModal = document.getElementById('apartmentModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
            if (event.target == apartmentModal) {
                apartmentModal.style.display = 'none';
            }
        }

        // Function to update apartment availability based on customer data
        function updateApartmentAvailability() {
            const apartmentData = JSON.parse(localStorage.getItem('apartmentData')) || {};
            const customers = JSON.parse(localStorage.getItem('customers')) || [];
            
            // Reset available units to total units
            Object.keys(apartmentData).forEach(type => {
                apartmentData[type].available = apartmentData[type].total;
            });
            
            // Decrease available units based on customer data
            customers.forEach(customer => {
                if (apartmentData[customer.apartmentType]) {
                    apartmentData[customer.apartmentType].available--;
                }
            });
            
            // Save updated apartment data
            localStorage.setItem('apartmentData', JSON.stringify(apartmentData));
            
            // Update display
            Object.entries(apartmentData).forEach(([type, data]) => {
                const elementId = type.toLowerCase().replace(' ', '-') + '-available';
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = `${data.available}/${data.total}`;
                    
                    // Update status indicator
                    const card = element.closest('.apartment-card');
                    const statusElement = card.querySelector('.status');
                    if (statusElement) {
                        if (data.available === 0) {
                            statusElement.textContent = 'Occupied';
                            statusElement.className = 'status occupied';
                        } else if (data.available <= 2) {
                            statusElement.textContent = 'Limited';
                            statusElement.className = 'status maintenance';
                        } else {
                            statusElement.textContent = 'Available';
                            statusElement.className = 'status available';
                        }
                    }
                }
            });
        }

        function showApartmentDetails(apartmentType) {
            const apartmentData = JSON.parse(localStorage.getItem('apartmentData')) || {};
            const customers = JSON.parse(localStorage.getItem('customers')) || [];
            const apartment = apartmentData[apartmentType];
            
            // Update modal title
            document.getElementById('modalApartmentTitle').textContent = `${apartmentType} Details`;
            
            // Update apartment information
            document.getElementById('modalTotalUnits').textContent = apartment.total;
            document.getElementById('modalAvailableUnits').textContent = apartment.available;
            
            // Set area and rent based on apartment type
            const areaRent = {
                '1BHK': { area: '500-600 sq.ft', rent: '₹15,000 - ₹20,000' },
                '2BHK': { area: '800-1000 sq.ft', rent: '₹25,000 - ₹35,000' },
                '3BHK': { area: '1200-1500 sq.ft', rent: '₹40,000 - ₹55,000' },
                'Single Bedroom': { area: '400-500 sq.ft', rent: '₹12,000 - ₹15,000' },
                'Studio': { area: '300-400 sq.ft', rent: '₹10,000 - ₹12,000' },
                'Penthouse': { area: '2000-2500 sq.ft', rent: '₹80,000 - ₹1,00,000' }
            };
            
            document.getElementById('modalApartmentArea').textContent = areaRent[apartmentType].area;
            document.getElementById('modalApartmentRent').textContent = areaRent[apartmentType].rent;
            
            // Update customer list
            const customerList = document.getElementById('modalCustomerList');
            const apartmentCustomers = customers.filter(c => c.apartmentType === apartmentType);
            
            if (apartmentCustomers.length === 0) {
                customerList.innerHTML = '<p>No customers currently in this apartment type.</p>';
            } else {
                customerList.innerHTML = apartmentCustomers.map(customer => `
                    <div class="customer-item">
                        <h4>${customer.fullname}</h4>
                        <p>Email: ${customer.email}</p>
                        <p>Phone: ${customer.phone}</p>
                        <p>Member Since: ${formatDate(customer.registrationDate)}</p>
                    </div>
                `).join('');
            }
            
            // Show the modal
            document.getElementById('apartmentModal').style.display = 'flex';
        }

        function closeApartmentModal() {
            document.getElementById('apartmentModal').style.display = 'none';
        }

        // Update the apartment card click handlers
        document.addEventListener('DOMContentLoaded', function() {
            // Add click handlers to all apartment cards
            const apartmentCards = document.querySelectorAll('.apartment-card');
            apartmentCards.forEach(card => {
                card.addEventListener('click', function() {
                    const apartmentType = this.querySelector('h3').textContent.replace(' Apartments', '');
                    showApartmentDetails(apartmentType);
                });
            });

            // Smooth scrolling for sidebar links
            document.querySelectorAll('.sidebar a').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    const href = this.getAttribute('href');
                    if (href.startsWith('#')) { // Only handle internal links
                        e.preventDefault();
                        const targetId = href.substring(1);
                        const targetElement = document.getElementById(targetId);
                        if (targetElement) {
                            targetElement.scrollIntoView({
                                behavior: 'smooth'
                            });
                            // Update active class
                            document.querySelectorAll('.sidebar a').forEach(link => link.classList.remove('active'));
                            this.classList.add('active');
                        } else if (href === '#profile' || href === '#orders' || href === '#payments' || href === '#settings') {
                            // For placeholder links, you might want to show an alert or navigate to another page
                            alert(`Navigating to ${href.substring(1)} section (placeholder for now).`);
                            document.querySelectorAll('.sidebar a').forEach(link => link.classList.remove('active'));
                            this.classList.add('active');
                        }
                    } else if (href === 'index.html') {
                        // Allow default navigation for logout
                        window.location.href = href;
                    }
                });
            });
        });

        // Function to get apartment details
        function getApartmentDetails(apartmentType) {
            const details = {
                '1BHK': { area: '500-600 sq.ft', rent: '₹15,000 - ₹20,000' },
                '2BHK': { area: '800-1000 sq.ft', rent: '₹25,000 - ₹35,000' },
                '3BHK': { area: '1200-1500 sq.ft', rent: '₹40,000 - ₹55,000' },
                'Single Bedroom': { area: '400-500 sq.ft', rent: '₹12,000 - ₹15,000' },
                'Studio': { area: '300-400 sq.ft', rent: '₹10,000 - ₹12,000' },
                'Penthouse': { area: '2000-2500 sq.ft', rent: '₹80,000 - ₹1,00,000' }
            };
            return details[apartmentType] || { area: 'N/A', rent: 'N/A' };
        }

        // Placeholder function to show the new customer bill form
        function showNewCustomerBillForm() {
            document.getElementById('newCustomerBillModal').style.display = 'block';
        }

        // Placeholder function to close the new customer bill form
        function closeNewCustomerBillModal() {
            document.getElementById('newCustomerBillModal').style.display = 'none';
        }

        // Handle new customer bill form submission
        document.getElementById('newCustomerBillForm').addEventListener('submit', function(event) {
            event.preventDefault();
            // In a real application, you would send this data to a backend server
            const customerName = document.getElementById('billCustomerName').value;
            const billAmount = document.getElementById('billAmount').value;
            const billDueDate = document.getElementById('billDueDate').value;
            const billDescription = document.getElementById('billDescription').value;

            alert(`New Bill Added for ${customerName}:\nAmount: ${billAmount}\nDue Date: ${billDueDate}\nDescription: ${billDescription}`);
            closeNewCustomerBillModal();
            // Clear form fields
            document.getElementById('newCustomerBillForm').reset();
        });
    </script>
</body>
</html> 